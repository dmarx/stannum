<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Dynamic Dimensions - Stannum</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../tin.html"><strong aria-hidden="true">2.</strong> Tin</a></li><li class="chapter-item expanded "><a href="../tube/basics.html"><strong aria-hidden="true">3.</strong> Tube</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../tube/advanced_field_construction.html"><strong aria-hidden="true">3.1.</strong> Advanced Field Construction</a></li><li class="chapter-item expanded "><a href="../tube/dynamic_dimensions.html" class="active"><strong aria-hidden="true">3.2.</strong> Dynamic Dimensions</a></li></ol></li><li class="chapter-item expanded "><a href="../complex_numbers.html"><strong aria-hidden="true">4.</strong> Complex Numbers</a></li><li class="chapter-item expanded "><a href="../contribution.html"><strong aria-hidden="true">5.</strong> Contribution</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Stannum</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="dynamic-dimension-calculation"><a class="header" href="#dynamic-dimension-calculation">Dynamic Dimension Calculation</a></h1>
<p>We first see what “dimension” means in the context of <code>stannum</code> and then see how we can leverage <code>DimensionCalculator</code> to enable dynamic dimension calculation</p>
<h2 id="dimension--shape"><a class="header" href="#dimension--shape">Dimension != Shape</a></h2>
<p>In <code>stannum</code>, “dimension” is virtual while “shape” is concrete. In other words, dimensions can be either integers or values of the enum <code>DimEnum</code> (namely <code>AnyDim</code>, <code>BatchDim</code> and <code>MatchDim(dim_id)</code>) while shapes can only mean integers.</p>
<p>After one dimension is concretized, a shape is produced. For example, dimensions <code>(AnyDim, 10)</code> contain both an integer and a <code>DimEnum</code>. To concretized the dimensions, we need a matching tensor, say a tensor of shapes <code>(123, 10)</code>, then the dimensions are concretized as <code>(123, 10)</code> as <code>AngDim</code> matches <code>123</code>. The same goes with dimensions that contains <code>BatchDim</code> and <code>MatchDim(dim_id)</code> besides some unification that is more complicated.</p>
<blockquote>
<p>Sidenote for developers: </p>
<p>In <a href="../../../src/stannum/tube.py">tube.py</a>, concretize_dimensions_and_unify() does exactly such concretization and unification!</p>
</blockquote>
<p>Of course, in this context, dimensions can be also shapes, which makes dimensions a superset of shapes, which makes dimensions more powerful.</p>
<h2 id="dimensioncalculator"><a class="header" href="#dimensioncalculator"><code>DimensionCalculator</code></a></h2>
<p>To calculate dimensions dynamically, we provide an API, which is <code>DimensionCalculator</code>, an abstract class containing only one method. So, alternatively, you can provide a closure as duck  <code>DimensionCalculator</code> implementation.</p>
<blockquote>
<p>Wait, why do we need dimensions/shapes in the first place?</p>
<p><code>Tube</code> help you manage fields automatically. By “manage”, it automatically create and destroy fields. In field creation, it needs (concrete) shapes instead of (virtual) dimensions. At the mean time, we need some way to express batching dimension, matching dimension and don’t-care (any) dimension, so we have dimensions.</p>
</blockquote>
<p>The specification of <code>DimensionCalculator</code> is as simple as below:</p>
<pre><code class="language-python">class DimensionCalculator(ABC):
    &quot;&quot;&quot;
    An interface for implementing a calculator that hints Tube how to construct fields
    &quot;&quot;&quot;

    @abstractmethod
    def calc_dimension(self,
                       field_name: str,
                       input_dimensions: Dict[str, Tuple[DimOption, ...]],
                       input_tensor_shapes: Dict[str, Tuple[int, ...]]) -&gt; Tuple[DimOption, ...]:
        &quot;&quot;&quot;
        Calculate dimensions for a output/intermediate field

        @param field_name: the name of the field for which the dimensions are calculated
        @param input_dimensions: the dict mapping names of input fields to input fields
        @param input_tensor_shapes: the dict mapping names of input fields to
        shapes of input tensors that correspond to input fields
        &quot;&quot;&quot;
        pass
</code></pre>
<p><code>field_name</code> is the name of an intermediate/output field for which dimensions are calculated. <code>input_dimensions</code> gives you all the information of dimensions of all input fields. <code>input_tensor_shapes</code> gives you all the information of shapes of input tensors, of which names are the names of input fields.</p>
<h2 id="example-convolution"><a class="header" href="#example-convolution">Example: Convolution</a></h2>
<p>In the case of convolution, the shapes and dimensions of a convolution kernel and an input (say an image) are needed to compute the shapes of output.</p>
<p>In <a href="../../../tests/test_tube/test_dynamic_shape.py">test_dynamic_shape.py</a>, there is a simple <code>DimensionCalculator</code> for 1D convolution, namely <code>D1ConvDC</code>. And you can see how to use it in the test cases.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../tube/advanced_field_construction.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../complex_numbers.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../tube/advanced_field_construction.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../complex_numbers.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </body>
</html>
